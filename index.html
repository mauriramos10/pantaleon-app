<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTBF / MTTR - Control de Fallas y Reparaciones</title>

  <!-- Chart.js (para gráficas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070b14; --bg1:#0b1220; --card:#111a2e; --line:#22304f;
      --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --chip:#0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0; color:var(--text);
      background: linear-gradient(180deg,var(--bg0),var(--bg1) 40%, var(--bg0));
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75);
      border-bottom:1px solid rgba(34,48,79,.6);
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 14px 16px; }
    .title{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:42px; height:42px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, #93c5fd, #2563eb 60%, #111a2e);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.08);
    }
    h1{ font-size: 16px; margin:0; letter-spacing:.2px; }
    .sub{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    button, .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,26,46,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: .15s transform, .15s background, .15s border;
      font-weight:600;
      font-size: 13px;
    }
    button:hover, .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(96,165,250,.5);
      background: rgba(17,26,46,1);
    }
    button.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(37,99,235,.18));
      border-color: rgba(96,165,250,.45);
    }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: rgba(17,26,46,.72);
      border:1px solid rgba(34,48,79,.7);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      font-size: 14px;
      margin:0;
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(34,48,79,.65);
    }
    .card .content{ padding: 14px; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .form .full{ grid-column: 1 / -1; }
    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.7);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 86px; resize: vertical; }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .hint{
      font-size: 12px; color: var(--muted);
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      background: rgba(15,23,42,.75);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
      display:flex; gap:8px; align-items:baseline;
    }
    .chip b{ font-size: 14px; }
    .chip .k{ color: var(--muted); font-weight:600; font-size: 11px; }
    .chip.ok b{ color: var(--ok); }
    .chip.warn b{ color: var(--warn); }
    .chip.bad b{ color: var(--bad); }

    .tableWrap{ overflow:auto; border-radius: 14px; border:1px solid rgba(34,48,79,.7); }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
      background: rgba(15,23,42,.55);
    }
    th, td{
      text-align:left;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(34,48,79,.55);
      font-size: 12px;
      vertical-align: top;
    }
    th{ color: var(--muted); font-size: 11px; letter-spacing:.3px; text-transform: uppercase; }
    tr:hover td{ background: rgba(17,26,46,.35); }
    .pill{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,26,46,.7);
      font-weight:700;
      font-size: 11px;
    }
    .pill.ok{ border-color: rgba(34,197,94,.4); color: var(--ok); }
    .pill.warn{ border-color: rgba(245,158,11,.45); color: var(--warn); }
    .pill.bad{ border-color: rgba(239,68,68,.45); color: var(--bad); }

    .smallBtns{ display:flex; gap:8px; }
    .small{
      padding: 6px 8px; border-radius: 10px; font-size: 12px;
    }
    .danger{ border-color: rgba(239,68,68,.45); }
    .danger:hover{ border-color: rgba(239,68,68,.75); }

    .sectionTitle{
      display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;
      margin: 10px 0 12px 0;
    }
    .sectionTitle .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .kpiNote{ font-size: 12px; color: var(--muted); }
    .split{
      display:grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }
    @media (max-width: 980px){ .split{ grid-template-columns:1fr; } }
    .canvasBox{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(34,48,79,.7);
      border-radius: 14px;
      padding: 10px;
    }
    footer{
      color: var(--muted);
      font-size: 12px;
      padding: 10px 16px 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    code.inline{
      background: rgba(15,23,42,.75);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 6px;
      border-radius: 8px;
      color: #c7d2fe;
    }
    .muted{ color: var(--muted); }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="title">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>MTBF / MTTR · Control de Fallas y Reparaciones</h1>
          <div class="sub">Registro, métricas y gráficas para evaluar calidad de mantenimiento y desempeño de mecánicos</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnExport">Exportar JSON</button>
        <label class="btn" for="fileImport" style="display:inline-flex;align-items:center;gap:8px;">
          Importar JSON
          <input id="fileImport" type="file" accept="application/json" style="display:none">
        </label>
        <button class="btn danger" id="btnReset">Borrar TODO</button>
      </div>
    </div>
  </div>
</header>

<div class="grid">

  <!-- IZQUIERDA: FORM + FILTROS + KPI -->
  <div class="card">
    <h2>Registrar Falla / Reparación</h2>
    <div class="content">
      <form id="frm" class="form" autocomplete="off">
        <div class="full">
          <label>Equipo (ej: Tractor 12, Bomba #3, Reductor 4…)</label>
          <input id="equipment" required placeholder="Nombre o código del equipo">
        </div>

        <div>
          <label>Mecánico</label>
          <input id="mechanic" required placeholder="Nombre del mecánico">
        </div>

        <div>
          <label>Severidad</label>
          <select id="severity">
            <option value="Baja">Baja</option>
            <option value="Media" selected>Media</option>
            <option value="Alta">Alta</option>
          </select>
        </div>

        <div class="full">
          <label>Descripción de la falla</label>
          <textarea id="failureDesc" placeholder="Ej: Fuga en sello, rodamiento recalentado, cadena floja…"></textarea>
        </div>

        <div>
          <label>Inicio de falla (equipo detenido)</label>
          <input id="tFailure" type="datetime-local" required>
        </div>

        <div>
          <label>Inicio reparación (cuando empieza a trabajar)</label>
          <input id="tRepairStart" type="datetime-local">
        </div>

        <div>
          <label>Fin reparación (equipo listo)</label>
          <input id="tRepairEnd" type="datetime-local" required>
        </div>

        <div>
          <label>Horas de operación desde última falla (opcional)</label>
          <input id="opHours" type="number" min="0" step="0.1" placeholder="Ej: 120.5">
        </div>

        <div class="full">
          <label>Acción correctiva / Repuestos / Notas</label>
          <textarea id="notes" placeholder="Ej: Se cambió rodamiento 6308, ajuste de alineación, torque…"></textarea>
        </div>

        <div class="full row">
          <button class="primary" type="submit" id="btnSave">Guardar registro</button>
          <button type="button" id="btnCancel" style="display:none;">Cancelar edición</button>
          <span class="hint" id="modeHint">Modo: Nuevo</span>
        </div>

        <div class="full">
          <div class="hint">
            Definiciones usadas:
            <br>• <b>MTTR</b> = promedio de <span class="muted">tiempo de reparación</span> (Fin - Inicio reparación; si no hay inicio reparación, usa Inicio falla).
            <br>• <b>MTBF</b> = promedio del tiempo entre <span class="muted">inicios de falla consecutivos</span> por equipo.
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- DERECHA: KPI + CHARTS + TABLA -->
  <div class="card">
    <h2>Panel de Métricas y Gráficas</h2>
    <div class="content">

      <!-- FILTROS -->
      <div class="sectionTitle">
        <div class="left">
          <b>Filtros</b>
          <span class="kpiNote">Afecta KPIs, gráficas y tabla</span>
        </div>
        <div class="row">
          <button class="btn" id="btnQuick7">Últimos 7 días</button>
          <button class="btn" id="btnQuick30">Últimos 30 días</button>
          <button class="btn" id="btnQuickAll">Todo</button>
        </div>
      </div>

      <div class="form" style="margin-bottom: 10px;">
        <div>
          <label>Desde</label>
          <input id="fFrom" type="date">
        </div>
        <div>
          <label>Hasta</label>
          <input id="fTo" type="date">
        </div>
        <div>
          <label>Equipo</label>
          <select id="fEquipment"><option value="">(Todos)</option></select>
        </div>
        <div>
          <label>Mecánico</label>
          <select id="fMechanic"><option value="">(Todos)</option></select>
        </div>
        <div>
          <label>Agrupar fallas por</label>
          <select id="fBucket">
            <option value="day">Día</option>
            <option value="week" selected>Semana</option>
            <option value="month">Mes</option>
          </select>
        </div>
        <div class="row" style="align-items:flex-end;">
          <button class="btn primary" id="btnApply">Aplicar</button>
          <button class="btn" id="btnClear">Limpiar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="chips" id="kpis"></div>

      <!-- CHARTS -->
      <div class="split" style="margin-top: 14px;">
        <div class="canvasBox">
          <div class="hint" style="margin: 2px 0 8px;">Fallas en el tiempo (conteo por periodo)</div>
          <canvas id="chartFailures" height="210"></canvas>
        </div>

        <div class="canvasBox">
          <div class="hint" style="margin: 2px 0 8px;">Mecánicos: MTTR promedio vs cantidad de reparaciones</div>
          <canvas id="chartMechanics" height="210"></canvas>
        </div>
      </div>

      <!-- TABLA -->
      <div class="sectionTitle" style="margin-top: 14px;">
        <div class="left">
          <b>Registros</b>
          <span class="kpiNote">Editar / eliminar desde la tabla</span>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Mecánico</th>
              <th>Sev.</th>
              <th>Inicio falla</th>
              <th>Inicio rep.</th>
              <th>Fin rep.</th>
              <th>Downtime</th>
              <th>Tiempo rep.</th>
              <th>MTBF (equipo)</th>
              <th>Notas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    </div>
  </div>

</div>

<footer>
  <div class="wrap" style="padding:0;">
    Todo se guarda en tu navegador (<code class="inline">localStorage</code>). Para usarlo en otro dispositivo, exporta JSON y luego impórtalo.
  </div>
</footer>

<script>
/* =========================
   UTILIDADES
========================= */
const LS_KEY = "mtbf_mttr_records_v1";

function uid(){
  return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function parseDT(v){
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}
function fmtDT(d){
  if(!d) return "—";
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function hoursBetween(a,b){
  if(!a || !b) return null;
  const ms = b.getTime() - a.getTime();
  return ms >= 0 ? ms/36e5 : null;
}
function fmtH(h){
  if(h === null || h === undefined) return "—";
  if(!isFinite(h)) return "—";
  return (Math.round(h*100)/100).toFixed(2) + " h";
}

function startOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function bucketKey(d, mode){
  // day, week, month
  const dd = new Date(d);
  if(mode === "day"){
    const x = startOfDay(dd);
    return x.toISOString().slice(0,10);
  }
  if(mode === "month"){
    return `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,"0")}`;
  }
  // week (ISO-ish simple): lunes como inicio
  const day = (dd.getDay()+6)%7; // lunes=0
  const monday = new Date(dd);
  monday.setDate(dd.getDate()-day);
  monday.setHours(0,0,0,0);
  const y = monday.getFullYear();
  const m = String(monday.getMonth()+1).padStart(2,"0");
  const da = String(monday.getDate()).padStart(2,"0");
  return `${y}-W(${m}-${da})`;
}

function severityClass(sev){
  if(sev === "Alta") return "bad";
  if(sev === "Media") return "warn";
  return "ok";
}

/* =========================
   DATOS
========================= */
let records = loadRecords();
let editId = null;

function loadRecords(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){
    return [];
  }
}
function saveRecords(){
  localStorage.setItem(LS_KEY, JSON.stringify(records));
}

function normalizeRecord(r){
  // asegura estructura
  return {
    id: r.id || uid(),
    equipment: (r.equipment || "").trim(),
    mechanic: (r.mechanic || "").trim(),
    severity: r.severity || "Media",
    failureDesc: r.failureDesc || "",
    tFailure: r.tFailure || "",
    tRepairStart: r.tRepairStart || "",
    tRepairEnd: r.tRepairEnd || "",
    opHours: (r.opHours === "" || r.opHours === null || r.opHours === undefined) ? "" : Number(r.opHours),
    notes: r.notes || ""
  };
}

/* =========================
   CÁLCULOS MTTR / MTBF
========================= */
function recordTimes(r){
  const tf = parseDT(r.tFailure);
  const trs = parseDT(r.tRepairStart);
  const tre = parseDT(r.tRepairEnd);

  const downtime = hoursBetween(tf, tre); // del paro al listo
  const repStart = trs || tf;
  const repairTime = hoursBetween(repStart, tre); // tiempo trabajando (si no hay inicio rep usa inicio falla)
  return { tf, trs, tre, downtime, repairTime };
}

function mtbfByEquipment(list){
  // MTBF por equipo usando inicios de falla
  const map = new Map();
  for(const r of list){
    const tf = parseDT(r.tFailure);
    if(!tf) continue;
    const eq = r.equipment || "—";
    if(!map.has(eq)) map.set(eq, []);
    map.get(eq).push(tf);
  }
  const out = new Map();
  for(const [eq, dates] of map.entries()){
    dates.sort((a,b)=>a-b);
    if(dates.length < 2){
      out.set(eq, null);
      continue;
    }
    let sum = 0, n = 0;
    for(let i=1;i<dates.length;i++){
      const h = hoursBetween(dates[i-1], dates[i]);
      if(h!==null){ sum += h; n++; }
    }
    out.set(eq, n ? (sum/n) : null);
  }
  return out;
}

function avg(arr){
  const v = arr.filter(x => x!==null && x!==undefined && isFinite(x));
  if(!v.length) return null;
  return v.reduce((a,b)=>a+b,0)/v.length;
}

function computeKPIs(filtered){
  const times = filtered.map(r => recordTimes(r));
  const mttrOverall = avg(times.map(x => x.repairTime));
  const downtimeOverall = avg(times.map(x => x.downtime));

  const mtbfMap = mtbfByEquipment(filtered);
  // MTBF general: promedio de MTBF por equipo (solo equipos con >=2 fallas)
  const mtbfOverall = avg([...mtbfMap.values()]);

  const total = filtered.length;
  const high = filtered.filter(r => r.severity==="Alta").length;

  return { mttrOverall, downtimeOverall, mtbfOverall, total, high };
}

/* =========================
   FILTROS
========================= */
function getFilters(){
  const from = document.querySelector("#fFrom").value;
  const to = document.querySelector("#fTo").value;
  const eq = document.querySelector("#fEquipment").value;
  const me = document.querySelector("#fMechanic").value;
  const bucket = document.querySelector("#fBucket").value;

  const fromD = from ? new Date(from+"T00:00:00") : null;
  const toD = to ? new Date(to+"T23:59:59") : null;

  return { fromD, toD, eq, me, bucket };
}

function applyFilters(){
  const { fromD, toD, eq, me } = getFilters();
  return records.filter(r=>{
    const tf = parseDT(r.tFailure);
    if(!tf) return false;
    if(fromD && tf < fromD) return false;
    if(toD && tf > toD) return false;
    if(eq && r.equipment !== eq) return false;
    if(me && r.mechanic !== me) return false;
    return true;
  });
}

/* =========================
   UI: DROPDOWNS
========================= */
function refreshDropdowns(){
  const eqSel = document.querySelector("#fEquipment");
  const meSel = document.querySelector("#fMechanic");
  const eqVal = eqSel.value;
  const meVal = meSel.value;

  const eqs = [...new Set(records.map(r=>r.equipment).filter(Boolean))].sort();
  const mes = [...new Set(records.map(r=>r.mechanic).filter(Boolean))].sort();

  eqSel.innerHTML = `<option value="">(Todos)</option>` + eqs.map(x=>`<option>${escapeHtml(x)}</option>`).join("");
  meSel.innerHTML = `<option value="">(Todos)</option>` + mes.map(x=>`<option>${escapeHtml(x)}</option>`).join("");

  if(eqs.includes(eqVal)) eqSel.value = eqVal;
  if(mes.includes(meVal)) meSel.value = meVal;
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   UI: KPIs
========================= */
function renderKPIs(filtered){
  const k = computeKPIs(filtered);

  const chips = [
    { k:"Registros", v: k.total, cls:"ok" },
    { k:"Fallas Alta", v: k.high, cls: k.high>0 ? "warn":"ok" },
    { k:"MTTR (prom.)", v: k.mttrOverall===null ? "—" : fmtH(k.mttrOverall), cls:"ok" },
    { k:"Downtime (prom.)", v: k.downtimeOverall===null ? "—" : fmtH(k.downtimeOverall), cls:"ok" },
    { k:"MTBF (prom.)", v: k.mtbfOverall===null ? "—" : fmtH(k.mtbfOverall), cls: k.mtbfOverall===null ? "warn":"ok" },
  ];

  document.querySelector("#kpis").innerHTML = chips.map(c => `
    <div class="chip ${c.cls}">
      <span class="k">${c.k}</span>
      <b>${c.v}</b>
    </div>
  `).join("");
}

/* =========================
   UI: TABLA
========================= */
function renderTable(filtered){
  const mtbfMap = mtbfByEquipment(filtered);

  // orden: más recientes primero
  const sorted = [...filtered].sort((a,b)=>{
    const da = parseDT(a.tFailure) || new Date(0);
    const db = parseDT(b.tFailure) || new Date(0);
    return db-da;
  });

  const tb = document.querySelector("#tbody");
  tb.innerHTML = sorted.map(r=>{
    const t = recordTimes(r);
    const mtbfEq = mtbfMap.get(r.equipment) ?? null;

    return `
      <tr>
        <td><b>${escapeHtml(r.equipment || "—")}</b></td>
        <td>${escapeHtml(r.mechanic || "—")}</td>
        <td><span class="pill ${severityClass(r.severity)}">${escapeHtml(r.severity)}</span></td>
        <td>${fmtDT(t.tf)}</td>
        <td>${fmtDT(t.trs)}</td>
        <td>${fmtDT(t.tre)}</td>
        <td>${fmtH(t.downtime)}</td>
        <td>${fmtH(t.repairTime)}</td>
        <td>${fmtH(mtbfEq)}</td>
        <td>${escapeHtml((r.notes || "").slice(0,120))}${(r.notes||"").length>120?"…":""}</td>
        <td>
          <div class="smallBtns">
            <button class="small" onclick="startEdit('${r.id}')">Editar</button>
            <button class="small danger" onclick="deleteRec('${r.id}')">Eliminar</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  if(!sorted.length){
    tb.innerHTML = `<tr><td colspan="11" class="muted">No hay registros con los filtros actuales.</td></tr>`;
  }
}

/* =========================
   CHARTS
========================= */
let chartFailures = null;
let chartMechanics = null;

function buildFailuresSeries(filtered, bucketMode){
  const map = new Map();
  for(const r of filtered){
    const tf = parseDT(r.tFailure);
    if(!tf) continue;
    const key = bucketKey(tf, bucketMode);
    map.set(key, (map.get(key)||0)+1);
  }
  const labels = [...map.keys()].sort();
  const data = labels.map(l => map.get(l));
  return { labels, data };
}

function buildMechanicSeries(filtered){
  const map = new Map(); // mechanic -> { times:[], count }
  for(const r of filtered){
    const m = r.mechanic || "—";
    const t = recordTimes(r);
    if(!map.has(m)) map.set(m, { times:[], count:0 });
    map.get(m).count++;
    if(t.repairTime!==null) map.get(m).times.push(t.repairTime);
  }
  const labels = [...map.keys()].sort((a,b)=>a.localeCompare(b));
  const avgMttr = labels.map(m => avg(map.get(m).times));
  const counts = labels.map(m => map.get(m).count);
  return { labels, avgMttr, counts };
}

function renderCharts(filtered){
  const { bucket } = getFilters();

  // Failures
  const fs = buildFailuresSeries(filtered, bucket);
  const ctxF = document.getElementById("chartFailures");
  if(chartFailures) chartFailures.destroy();
  chartFailures = new Chart(ctxF, {
    type: "bar",
    data: {
      labels: fs.labels,
      datasets: [{
        label: "Fallas",
        data: fs.data
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: { ticks: { color: "#cbd5e1" }, grid: { color: "rgba(34,48,79,.35)" } },
        y: { beginAtZero: true, ticks: { color: "#cbd5e1" }, grid: { color: "rgba(34,48,79,.35)" } }
      }
    }
  });

  // Mechanics
  const ms = buildMechanicSeries(filtered);
  const ctxM = document.getElementById("chartMechanics");
  if(chartMechanics) chartMechanics.destroy();
  chartMechanics = new Chart(ctxM, {
    type: "bar",
    data: {
      labels: ms.labels,
      datasets: [
        {
          label: "MTTR promedio (h)",
          data: ms.avgMttr.map(v => v===null ? 0 : v),
          yAxisID: "y"
        },
        {
          type: "line",
          label: "Reparaciones (conteo)",
          data: ms.counts,
          yAxisID: "y1",
          tension: 0.25
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        x: { ticks: { color: "#cbd5e1" }, grid: { color: "rgba(34,48,79,.35)" } },
        y: { beginAtZero: true, position: "left",
          ticks: { color: "#cbd5e1" }, grid: { color: "rgba(34,48,79,.35)" },
          title: { display: true, text: "Horas", color: "#9ca3af" }
        },
        y1: { beginAtZero: true, position: "right",
          ticks: { color: "#cbd5e1" }, grid: { drawOnChartArea: false },
          title: { display: true, text: "Cantidad", color: "#9ca3af" }
        }
      }
    }
  });
}

/* =========================
   RENDER GENERAL
========================= */
function render(){
  refreshDropdowns();
  const filtered = applyFilters();
  renderKPIs(filtered);
  renderTable(filtered);
  renderCharts(filtered);
}

/* =========================
   CRUD
========================= */
function upsertRecord(rec){
  const r = normalizeRecord(rec);
  const idx = records.findIndex(x => x.id === r.id);
  if(idx >= 0) records[idx] = r;
  else records.push(r);
  saveRecords();
  render();
}

function deleteRec(id){
  const r = records.find(x => x.id === id);
  if(!r) return;
  if(!confirm(`¿Eliminar el registro de ${r.equipment} (${r.mechanic})?`)) return;
  records = records.filter(x => x.id !== id);
  saveRecords();
  if(editId === id) cancelEdit();
  render();
}
window.deleteRec = deleteRec;

function startEdit(id){
  const r = records.find(x => x.id === id);
  if(!r) return;
  editId = id;

  document.querySelector("#equipment").value = r.equipment || "";
  document.querySelector("#mechanic").value = r.mechanic || "";
  document.querySelector("#severity").value = r.severity || "Media";
  document.querySelector("#failureDesc").value = r.failureDesc || "";
  document.querySelector("#tFailure").value = r.tFailure || "";
  document.querySelector("#tRepairStart").value = r.tRepairStart || "";
  document.querySelector("#tRepairEnd").value = r.tRepairEnd || "";
  document.querySelector("#opHours").value = r.opHours === "" ? "" : (r.opHours ?? "");
  document.querySelector("#notes").value = r.notes || "";

  document.querySelector("#btnCancel").style.display = "inline-block";
  document.querySelector("#modeHint").textContent = "Modo: Editando";
  document.querySelector("#btnSave").textContent = "Guardar cambios";
  window.scrollTo({ top: 0, behavior: "smooth" });
}
window.startEdit = startEdit;

function cancelEdit(){
  editId = null;
  document.querySelector("#frm").reset();
  document.querySelector("#btnCancel").style.display = "none";
  document.querySelector("#modeHint").textContent = "Modo: Nuevo";
  document.querySelector("#btnSave").textContent = "Guardar registro";
}
window.cancelEdit = cancelEdit;

/* =========================
   EVENTOS
========================= */
document.querySelector("#frm").addEventListener("submit", (e)=>{
  e.preventDefault();

  const equipment = document.querySelector("#equipment").value.trim();
  const mechanic = document.querySelector("#mechanic").value.trim();
  const severity = document.querySelector("#severity").value;
  const failureDesc = document.querySelector("#failureDesc").value.trim();
  const tFailure = document.querySelector("#tFailure").value;
  const tRepairStart = document.querySelector("#tRepairStart").value;
  const tRepairEnd = document.querySelector("#tRepairEnd").value;
  const opHoursRaw = document.querySelector("#opHours").value;
  const notes = document.querySelector("#notes").value.trim();

  const tf = parseDT(tFailure);
  const tre = parseDT(tRepairEnd);
  if(!tf || !tre){
    alert("Revisa fechas: Inicio de falla y Fin de reparación son obligatorios.");
    return;
  }
  if(tre < tf){
    alert("Fin de reparación no puede ser antes del inicio de falla.");
    return;
  }
  if(tRepairStart){
    const trs = parseDT(tRepairStart);
    if(trs && (trs < tf || trs > tre)){
      alert("Inicio de reparación debe estar entre Inicio de falla y Fin de reparación.");
      return;
    }
  }

  const rec = {
    id: editId || uid(),
    equipment, mechanic, severity, failureDesc,
    tFailure, tRepairStart, tRepairEnd,
    opHours: opHoursRaw === "" ? "" : Number(opHoursRaw),
    notes
  };

  upsertRecord(rec);
  cancelEdit();
});

document.querySelector("#btnCancel").addEventListener("click", cancelEdit);

document.querySelector("#btnApply").addEventListener("click", (e)=>{ e.preventDefault(); render(); });
document.querySelector("#btnClear").addEventListener("click", (e)=>{
  e.preventDefault();
  document.querySelector("#fFrom").value = "";
  document.querySelector("#fTo").value = "";
  document.querySelector("#fEquipment").value = "";
  document.querySelector("#fMechanic").value = "";
  document.querySelector("#fBucket").value = "week";
  render();
});

function setQuickRange(days){
  const today = new Date();
  const to = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const from = new Date(to);
  from.setDate(from.getDate() - (days-1));

  const pad = n => String(n).padStart(2,"0");
  const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  document.querySelector("#fFrom").value = fmt(from);
  document.querySelector("#fTo").value = fmt(to);
  render();
}
document.querySelector("#btnQuick7").addEventListener("click", ()=>setQuickRange(7));
document.querySelector("#btnQuick30").addEventListener("click", ()=>setQuickRange(30));
document.querySelector("#btnQuickAll").addEventListener("click", ()=>{
  document.querySelector("#fFrom").value = "";
  document.querySelector("#fTo").value = "";
  render();
});

/* =========================
   EXPORT / IMPORT
========================= */
document.querySelector("#btnExport").addEventListener("click", ()=>{
  const payload = {
    exportedAt: new Date().toISOString(),
    version: 1,
    records
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `mtbf_mttr_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

document.querySelector("#fileImport").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    const imported = (obj.records || obj || []);
    const normalized = imported.map(normalizeRecord);

    if(!Array.isArray(normalized)) throw new Error("Formato inválido");
    // merge por id (si existe, actualiza)
    for(const r of normalized){
      const idx = records.findIndex(x => x.id === r.id);
      if(idx >= 0) records[idx] = r;
      else records.push(r);
    }
    saveRecords();
    render();
    alert("Importación completada.");
  }catch(err){
    alert("No pude importar ese archivo. Asegúrate que sea JSON de esta app.");
  }finally{
    e.target.value = "";
  }
});

document.querySelector("#btnReset").addEventListener("click", ()=>{
  if(!confirm("Esto borrará todos los registros guardados en este navegador. ¿Continuar?")) return;
  records = [];
  saveRecords();
  cancelEdit();
  render();
});

/* =========================
   INIT
========================= */
(function init(){
  // sugerir fecha/hora actual en el formulario
  const now = new Date();
  const pad = n => String(n).padStart(2,"0");
  const dtLocal = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

  document.querySelector("#tFailure").value = dtLocal(now);
  const end = new Date(now); end.setHours(end.getHours()+1);
  document.querySelector("#tRepairEnd").value = dtLocal(end);

  refreshDropdowns();
  render();
})();
</script>

</body>
</html>
