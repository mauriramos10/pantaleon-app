<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Fallas</title>
  <style>
    :root { --b:#111827; --g:#6b7280; --bg:#0b1220; --card:#111a2e; --line:#22304f; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background: linear-gradient(180deg,#070b14,#0b1220 40%, #070b14); color:#e5e7eb; }
    header { position: sticky; top:0; backdrop-filter: blur(10px); background: rgba(11,18,32,.7); border-bottom:1px solid rgba(34,48,79,.7); z-index:10; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px 14px 22px; }
    h1 { font-size: 18px; margin: 0; display:flex; align-items:center; gap:10px; }
    .pill { font-size: 12px; color:#cbd5e1; padding:4px 10px; border:1px solid rgba(34,48,79,.9); border-radius:999px; background: rgba(17,26,46,.6); }
    nav { display:flex; gap:8px; margin-top: 10px; flex-wrap: wrap; }
    .tab { border:1px solid rgba(34,48,79,.9); background: rgba(17,26,46,.55); color:#e5e7eb; padding:8px 10px; border-radius: 10px; cursor:pointer; font-weight: 600; }
    .tab.active { outline: 2px solid rgba(99,102,241,.6); }
    .row { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    @media (min-width: 900px) { .row.two { grid-template-columns: 1.2fr .8fr; } }
    .card { background: rgba(17,26,46,.7); border: 1px solid rgba(34,48,79,.9); border-radius: 14px; padding: 12px; box-shadow: 0 8px 30px rgba(0,0,0,.35); }
    .card h2 { margin:0 0 10px; font-size: 15px; color:#e2e8f0; display:flex; align-items:center; justify-content: space-between; gap:10px; }
    .muted { color:#94a3b8; font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 700px) { .grid.cols2 { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size: 12px; color:#cbd5e1; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 10px; border:1px solid rgba(34,48,79,.9); background: rgba(2,6,23,.5); color:#e5e7eb; }
    textarea { min-height: 90px; resize: vertical; }
    .btns { display:flex; gap:8px; flex-wrap: wrap; }
    button { border:1px solid rgba(34,48,79,.9); background: rgba(2,6,23,.35); color:#e5e7eb; padding: 9px 12px; border-radius: 10px; cursor:pointer; font-weight: 700; }
    button.primary { background: rgba(99,102,241,.25); border-color: rgba(99,102,241,.6); }
    button.good { background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.55); }
    button.danger { background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.55); }
    button:disabled { opacity:.5; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid rgba(34,48,79,.7); vertical-align: top; }
    th { text-align: left; color:#cbd5e1; font-size: 12px; font-weight: 800; }
    .badge { display:inline-flex; align-items:center; gap:6px; font-size: 12px; padding:4px 8px; border-radius: 999px; border: 1px solid rgba(34,48,79,.9); background: rgba(2,6,23,.35); }
    .b-ok { border-color: rgba(34,197,94,.6); }
    .b-warn { border-color: rgba(245,158,11,.7); }
    .b-bad { border-color: rgba(239,68,68,.7); }
    .right { text-align:right; }
    .actions { display:flex; gap:6px; flex-wrap: wrap; justify-content: flex-end; }
    .small { padding:6px 8px; font-size: 12px; border-radius: 10px; }
    .toast { position: fixed; right: 14px; bottom: 14px; max-width: 360px; z-index: 9999; display:flex; flex-direction: column; gap:8px; }
    .toast .t { background: rgba(17,26,46,.92); border: 1px solid rgba(34,48,79,.9); border-left-width: 6px; border-radius: 12px; padding: 10px; box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    .t.good { border-left-color: var(--ok); }
    .t.warn { border-left-color: var(--warn); }
    .t.bad { border-left-color: var(--bad); }
    .t .title { font-weight: 900; margin-bottom: 4px; }
    .t .meta { color:#94a3b8; font-size: 12px; }
    dialog { border:none; border-radius: 16px; padding:0; max-width: 720px; width: calc(100% - 24px); background: rgba(17,26,46,.98); color:#e5e7eb; box-shadow: 0 25px 60px rgba(0,0,0,.6); }
    dialog::backdrop { background: rgba(0,0,0,.55); }
    .dlg { padding: 12px; border:1px solid rgba(34,48,79,.9); border-radius: 16px; }
    .dlg h3 { margin: 0 0 10px; font-size: 15px; }
    .hr { height:1px; background: rgba(34,48,79,.7); margin: 10px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Control de Fallas <span class="pill" id="pillStatus">Guardado local</span></h1>
    <nav>
      <button class="tab active" data-tab="fallas">Fallas</button>
      <button class="tab" data-tab="equipos">Equipos</button>
      <button class="tab" data-tab="alertas">Alertas / Respaldo</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- FALLAS -->
  <section id="tab-fallas" class="tabpane">
    <div class="row two">
      <div class="card">
        <h2>
          <span>Registrar falla</span>
          <span class="muted">Fecha/hora local (Guatemala)</span>
        </h2>
        <div class="grid cols2">
          <div>
            <label>Equipo</label>
            <input id="fEquipoTxt" list="equiposList" placeholder="Escribe código o nombre (ej: 10010416)" />
<datalist id="equiposList"></datalist>
<input type="hidden" id="fEquipo" />

          </div>
          <div>
            <label>Tipo / título corto</label>
            <input id="fTitulo" placeholder="Ej: Banda se desliza / Motor no arranca" />
          </div>
          <div>
            <label>Fecha y hora de la falla</label>
            <input id="fFecha" type="datetime-local" />
          </div>
          <div>
            <label>Umbral aviso (horas) (opcional)</label>
            <input id="fUmbral" type="number" min="0" step="0.5" placeholder="Vacío = usar configuración global" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>Descripción / detalle</label>
          <textarea id="fDetalle" placeholder="Describe lo ocurrido, síntomas, condiciones, etc."></textarea>
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="primary" id="btnCrearFalla">Guardar falla</button>
          <button id="btnAutofecha">Poner fecha/hora actual</button>
        </div>
      </div>

      <div class="card">
        <h2>
          <span>Filtro rápido</span>
          <span class="badge" id="badgePendientes">Pendientes: 0</span>
        </h2>
        <div class="grid">
          <div>
            <label>Buscar (equipo / título / detalle)</label>
            <input id="qBuscar" placeholder="Escribe para filtrar..." />
          </div>
          <div class="grid cols2">
            <div>
              <label>Estado</label>
              <select id="qEstado">
                <option value="todos">Todos</option>
                <option value="pendientes">Pendientes</option>
                <option value="solucionadas">Solucionadas</option>
              </select>
            </div>
            <div>
              <label>Equipo</label>
              <select id="qEquipo">
                <option value="todos">Todos</option>
              </select>
            </div>
          </div>
          <div class="grid cols2">
            <div>
              <label>Orden</label>
              <select id="qOrden">
                <option value="recientes">Más recientes</option>
                <option value="antiguas">Más antiguas</option>
                <option value="mas_atrasadas">Más atrasadas (pendientes)</option>
              </select>
            </div>
            <div>
              <label>Solo alertas activas</label>
              <select id="qSoloAlertas">
                <option value="no">No</option>
                <option value="si">Sí</option>
              </select>
            </div>
          </div>

          <div class="btns">
            <button id="btnPermisoNotif">Activar notificaciones</button>
            <button class="danger" id="btnResetDemo" title="Borra todo">Borrar todo</button>
          </div>
          <div class="muted">
            * Las notificaciones dependen del navegador y permisos. Aunque no se notifique, siempre verás avisos en pantalla.
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>
        <span>Historial de fallas</span>
        <span class="muted" id="lblConteo"></span>
      </h2>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Estado</th>
              <th>Equipo</th>
              <th>Falla</th>
              <th>Fecha/hora</th>
              <th>Atraso</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbFallas"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- EQUIPOS -->
  <section id="tab-equipos" class="tabpane" style="display:none">
    <div class="row two">
      <div>
        <div class="card">
          <h2>Registrar equipo</h2>
          <div class="grid cols2">
            <div>
              <label>Código de equipo</label>
              <input id="eCodigo" placeholder="Ej: 10010356" />
            </div>
            <div>
              <label>Denominación</label>
              <input id="eNombre" placeholder="Ej: TRACTOR JOHN DEERE 8245R" />
            </div>
            <div>
              <label>Área / Frente</label>
              <input id="eArea" placeholder="Ej: Fertilización / Escarificado / Taller" />
            </div>
            <div>
              <label>Marca / Modelo</label>
              <input id="eModelo" placeholder="Ej: John Deere 6110 / CASE PUMA 225" />
            </div>
            <div>
              <label>Serie / Placa</label>
              <input id="eSerie" placeholder="Opcional" />
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Notas del equipo</label>
            <textarea id="eNotas" placeholder="Detalles importantes del equipo (capacidad, ubicación, etc.)"></textarea>
          </div>
          <div class="btns" style="margin-top:10px">
            <button class="primary" id="btnCrearEquipo">Guardar equipo</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Importar equipos pegando lista</h2>
          <div class="muted">
            Pega líneas como: <span class="mono">10010356[TAB]TRACTOR AGRICOLA JOHN DEERE D130</span> (también acepta separador por espacios múltiples).
          </div>
          <div style="margin-top:10px">
            <label>Lista (una línea por equipo)</label>
            <textarea id="eImportText" placeholder="Código[TAB]Denominación"></textarea>
          </div>
          <div class="btns" style="margin-top:10px">
            <button class="primary" id="btnImportEquiposPegado">Importar/Agregar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Listado de equipos</h2>
        <div class="muted">Puedes editar o eliminar (si eliminas un equipo, sus fallas quedan “huérfanas” y se verán como “Equipo eliminado”).</div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th>Denominación</th>
                <th>Área</th>
                <th>Modelo</th>
                <th class="right">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbEquipos"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ALERTAS / RESPALDO -->
  <section id="tab-alertas" class="tabpane" style="display:none">
    <div class="row two">
      <div class="card">
        <h2>Configuración de avisos</h2>
        <div class="grid">
          <div class="grid cols2">
            <div>
              <label>Umbral global (horas)</label>
              <input id="cfgUmbral" type="number" min="0" step="0.5" />
              <div class="muted">Si una falla no tiene umbral propio, se usa este.</div>
            </div>
            <div>
              <label>Repetir aviso cada (minutos)</label>
              <input id="cfgRepetir" type="number" min="1" step="1" />
              <div class="muted">Evita spam: el sistema espera este tiempo para volver a avisar por la misma falla.</div>
            </div>
          </div>
          <div class="btns">
            <button class="primary" id="btnGuardarCfg">Guardar configuración</button>
            <button id="btnTestAviso">Probar aviso</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Respaldo / Exportar</h2>
        <div class="grid">
          <div class="btns">
            <button class="primary" id="btnExportar">Exportar JSON</button>
            <button id="btnImportar">Importar JSON</button>
          </div>
          <div class="muted">
            Exporta a un archivo para guardarlo en WhatsApp/Drive y poder restaurar si cambias de teléfono.
          </div>
          <input id="fileImport" type="file" accept="application/json" style="display:none" />
        </div>
        <div class="hr"></div>
        <div class="muted mono" id="dbgInfo"></div>
      </div>
    </div>
  </section>

  <dialog id="dlgFalla">
    <div class="dlg">
      <h3>Editar falla</h3>
      <div class="grid cols2">
        <div>
          <label>Equipo</label>
          <select id="dEquipo"></select>
        </div>
        <div>
          <label>Título</label>
          <input id="dTitulo" />
        </div>
        <div>
          <label>Fecha/hora</label>
          <input id="dFecha" type="datetime-local" />
        </div>
        <div>
          <label>Umbral aviso (horas)</label>
          <input id="dUmbral" type="number" min="0" step="0.5" placeholder="Vacío = global" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Detalle</label>
        <textarea id="dDetalle"></textarea>
      </div>

      <div class="grid cols2" style="margin-top:10px">
        <div>
          <label>Estado</label>
          <select id="dEstado">
            <option value="pendiente">Pendiente</option>
            <option value="solucionada">Solucionada</option>
          </select>
        </div>
        <div>
          <label>Notas de solución (si aplica)</label>
          <input id="dSolucion" placeholder="Ej: se cambió sensor / se ajustó correa..." />
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <h3 style="margin:0 0 6px; font-size:14px;">Comentarios</h3>
        <div class="muted" id="dComentariosInfo"></div>
        <div style="margin-top:8px">
          <label>Nuevo comentario</label>
          <textarea id="dNuevoComentario" placeholder="Agrega observaciones, repuestos, quién atendió, etc."></textarea>
          <div class="btns" style="margin-top:8px">
            <button class="good" id="btnAddComentario">Agregar comentario</button>
          </div>
        </div>

        <div class="hr"></div>
        <div id="dComentariosLista"></div>
      </div>

      <div class="btns" style="margin-top:12px; justify-content:flex-end">
        <button id="btnCerrarDlg">Cerrar</button>
        <button class="primary" id="btnGuardarFallaEdit">Guardar cambios</button>
      </div>
    </div>
  </dialog>

  <dialog id="dlgEquipo">
    <div class="dlg">
      <h3>Editar equipo</h3>
      <div class="grid cols2">
        <div>
          <label>Código</label>
          <input id="deCodigo" />
        </div>
        <div>
          <label>Denominación</label>
          <input id="deNombre" />
        </div>
        <div>
          <label>Área</label>
          <input id="deArea" />
        </div>
        <div>
          <label>Marca / Modelo</label>
          <input id="deModelo" />
        </div>
        <div>
          <label>Serie / Placa</label>
          <input id="deSerie" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Notas</label>
        <textarea id="deNotas"></textarea>
      </div>
      <div class="btns" style="margin-top:12px; justify-content:flex-end">
        <button id="btnCerrarDlgEq">Cerrar</button>
        <button class="primary" id="btnGuardarEquipoEdit">Guardar cambios</button>
      </div>
    </div>
  </dialog>

</main>

<div class="toast" id="toast"></div>

<script>
/* ===========================
   Control de Fallas (local)
   =========================== */

const STORE_KEY = "controlFallas.v1";

const PRELOAD_EQUIPOS = [
  { codigo:"10010356", denominacion:"TRACTOR AGRICOLA JOHN DEERE D130" },
  { codigo:"10010357", denominacion:"TRACTOR AGRICOLA JOHN DEERE D130" },
  { codigo:"10010125", denominacion:"TRACTOR AGRICOLA JOHN DEERE 5615" },
  { codigo:"10130021", denominacion:"ESCARIFICADOR" },
  { codigo:"10130022", denominacion:"ESCARIFICADOR" },
  { codigo:"10130025", denominacion:"ESCARIFICADOR" },
  { codigo:"10130030", denominacion:"ESCARIFICADOR" },
  { codigo:"10130031", denominacion:"ESCARIFICADOR" },
  { codigo:"10130032", denominacion:"ESCARIFICADOR" },
  { codigo:"10130033", denominacion:"ESCARIFICADOR" },
  { codigo:"10130034", denominacion:"ESCARIFICADOR" },
  { codigo:"10130035", denominacion:"ESCARIFICADOR" },
  { codigo:"10130241", denominacion:"ESCARIFICADOR" },
  { codigo:"10130419", denominacion:"ESCARIFICADOR DE  4 CINCELES" },
  { codigo:"11130006", denominacion:"ESCARIFICADOR" },
  { codigo:"11130007", denominacion:"ESCARIFICADOR" },
  { codigo:"10130439", denominacion:"SUBSOLADOR" },
  { codigo:"10130440", denominacion:"SUBSOLADOR" },
  { codigo:"10130443", denominacion:"SUBSOLADOR" },
  { codigo:"10130051", denominacion:"FERTILIZADORA ABONO GRANULADO" },
  { codigo:"10130027", denominacion:"ESCARIFICADOR" },
  { codigo:"10010416", denominacion:"TRACTOR JOHN DEERE 8245R" },
  { codigo:"10010508", denominacion:"TRACTOR JOHN DEERE 7210R" },
  { codigo:"10010506", denominacion:"TRACTOR JOHN DEERE 7210R" },
  { codigo:"10010415", denominacion:"TRACTOR JOHN DEERE 8245R" },
  { codigo:"10010511", denominacion:"TRACTOR JOHN DEERE 7210R" },
  { codigo:"10010429", denominacion:"TRACTOR JOHN DEERE 6155J DT" },
  { codigo:"10010430", denominacion:"TRACTOR JOHN DEERE 6155J DT" },
  { codigo:"10010434", denominacion:"TRACTOR JOHN DEERE 6155J DT" },
  { codigo:"10010447", denominacion:"TRACTOR JOHN DEERE 6155J DT" },
  { codigo:"10010503", denominacion:"TRACTOR JOHN DEERE 7210R" },
  { codigo:"10130350", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130351", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130352", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130353", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130405", denominacion:"FERTILIZADORA ABONO LIQUIDO ALTO VOLUMEN" },
  { codigo:"10130452", denominacion:"FERTILIZADORA ABONO LIQUIDO ALTO VOLUMEN" },
  { codigo:"10130430", denominacion:"TANQUE ABONO LIQUIDO DE  ALTO VOLUMEN" },
  { codigo:"10130425", denominacion:"TANQUE ABONO LIQUIDO DE  ALTO VOLUMEN" },
  { codigo:"10130454", denominacion:"FERTILIZADORA ABONO LIQUIDO ALTO VOLUMEN" },
  { codigo:"10130085", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130082", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130081", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130083", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130084", denominacion:"FERTILIZADORA ABONO LIQUIDO" },
  { codigo:"10130311", denominacion:"FERTICULTIVADORA DE ABONO LIQUIDO" },
  { codigo:"10130346", denominacion:"FERTICULTIVADORA DE ABONO LIQUIDO" },
  { codigo:"10130471", denominacion:"COMPOSTADORA DE SUELOS" },
  { codigo:"10130409", denominacion:"COMPOSTADORA DE SUELOS" },
  { codigo:"10010152", denominacion:"TRACTOR AGRICOLA JOHN DEERE 7425" },
  { codigo:"10130339", denominacion:"ENCALADORA" },
  { codigo:"10130402", denominacion:"ENCALADORA CACHAZERA" },
  { codigo:"10130240", denominacion:"ESCARIFICADOR..." },
  { codigo:"10010348", denominacion:"TRACTOR AGRICOLA JOHN DEERE 8245R" },
  { codigo:"10010687", denominacion:"TRACTOR AGRICOLA CASE FARMALL 100" },
  { codigo:"10130067", denominacion:"FERTILIZADORA ABONO GRANULADO" },
  { codigo:"10130466", denominacion:"FERTILIZADORA ABONO LIQUIDO ALTO VOLUMEN" },
  { codigo:"10130465", denominacion:"FERTILIZADORA ABONO LIQUIDO ALTO VOLUMEN" },
  { codigo:"10010465", denominacion:"TRACTOR CASE IH PUMA" },
  { codigo:"10051856", denominacion:"CAMIÓN HINO 2023" },
  { codigo:"10051598", denominacion:"CAMIÓN HINO 2020" },
  { codigo:"10051704", denominacion:"CAMION HINO 5.25 TON" },
  { codigo:"10010405", denominacion:"TRACTOR JOHN DEERE 8345R" },
  { codigo:"10010491", denominacion:"TRACTOR AGRICOLA JOHN DEERE 7425" },
  { codigo:"10010557", denominacion:"TRACTOR AGRICOLA CASE PUMA 210" },
  { codigo:"10010376", denominacion:"TRACTOR JOHN DEERE 7210R" },
  { codigo:"10010475", denominacion:"TRACTOR JOHN DEEREE 7210R" },
  { codigo:"10010464", denominacion:"TRACTOR AGRÍCOLA CASE PUMA 210" },
  { codigo:"10010466", denominacion:"TRACTOR CASE IH PUMA" },
  { codigo:"10010714", denominacion:"TRACTOR AGRICOLA CASE PUMA 225" },
  { codigo:"10010713", denominacion:"TRACTOR AGRICOLA CASE PUMA 225" },
  { codigo:"10010716", denominacion:"TRACTOR AGRICOLA CASE PUMA 225" },
  { codigo:"10010715", denominacion:"TRACTOR AGRICOLA CASE PUMA 225" },
  { codigo:"10130481", denominacion:"ESCARIFICADOR DE  4 CINCELES" },
  { codigo:"10130482", denominacion:"ESCARIFICADOR DE  4 CINCELES" },
  { codigo:"10130073", denominacion:"FERTILIZADORA DE ABONO LIQUIDO" },
  { codigo:"10010549", denominacion:"TRACTOR AGRICOLA CASE PUMA 210" },
  { codigo:"10130312", denominacion:"FERTILIZADORA DE ABONO LIQUIDO" },
  { codigo:"10010490", denominacion:"TRACTOR AGRICOLA JOHN DEERE 7425" },
  { codigo:"11130009", denominacion:"FERTILIZADORA ABONO GRANULADO" },
  { codigo:"10010717", denominacion:"TRACTOR AGRICOLA CASE PUMA 225" },
  { codigo:"10010718", denominacion:"TRACTOR AGRICOLA CASE PUMA 225" },
  { codigo:"10010413", denominacion:"TRACTOR JOHN DEERE 8245R" },
  { codigo:"10010417", denominacion:"TRACTOR JOHN DEERE 8245R" },
  { codigo:"10010374", denominacion:"TRACTOR JOHN DEERE 7210R" },
  { codigo:"10070279", denominacion:"GONDOLA" },
  { codigo:"10130438", denominacion:"ENCALADORA CIVEMASA" },
  { codigo:"10130239", denominacion:"ECARFICADOR" },
  { codigo:"10010414", denominacion:"TRACTOR JOHN DEERE 8245R" },
  { codigo:"10130061", denominacion:"FERTILIZADORA ABONO GRANULAD" },
  { codigo:"10010736", denominacion:"TRACTOR AGRÍCOLA 6140J" }
];

const nowLocalISO = () => {
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
};

function uid(prefix="id") {
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    if (!raw) return defaultState();
    const s = JSON.parse(raw);
    return normalizeState(s);
  } catch {
    return defaultState();
  }
}

function saveState() {
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  pillStatus.textContent = "Guardado ✔";
  setTimeout(()=> pillStatus.textContent = "Guardado local", 900);
}

function defaultState() {
  return normalizeState({
    config: { thresholdHours: 6, repeatMinutes: 30 },
    equipos: PRELOAD_EQUIPOS.map(x => ({
      id: uid("eq"),
      codigo: x.codigo,
      nombre: x.denominacion,
      area: "",
      modelo: "",
      serie: "",
      notas: ""
    })),
    fallas: []
  });
}

function normalizeState(s) {
  if (!s || typeof s !== "object") s = {};
  s.config ??= { thresholdHours: 6, repeatMinutes: 30 };
  if (typeof s.config.thresholdHours !== "number") s.config.thresholdHours = 6;
  if (typeof s.config.repeatMinutes !== "number") s.config.repeatMinutes = 30;
  s.equipos = Array.isArray(s.equipos) ? s.equipos : [];
  s.fallas = Array.isArray(s.fallas) ? s.fallas : [];

  for (const e of s.equipos) {
    if (!("codigo" in e)) e.codigo = "";
  }

  for (const f of s.fallas) {
    f.comentarios = Array.isArray(f.comentarios) ? f.comentarios : [];
    if (typeof f.resuelta !== "boolean") f.resuelta = false;
    if (!f.createdAt) f.createdAt = new Date().toISOString();
    if (!("lastNotifiedAt" in f)) f.lastNotifiedAt = null;
  }
  return s;
}

let state = loadState();

/* ===========================
   DOM refs
   =========================== */
const pillStatus = document.getElementById("pillStatus");
const tabs = [...document.querySelectorAll(".tab")];
const panes = {
  fallas: document.getElementById("tab-fallas"),
  equipos: document.getElementById("tab-equipos"),
  alertas: document.getElementById("tab-alertas")
};

// Crear falla
const fEquipo = document.getElementById("fEquipo");
const fTitulo = document.getElementById("fTitulo");
const fFecha = document.getElementById("fFecha");
const fUmbral = document.getElementById("fUmbral");
const fDetalle = document.getElementById("fDetalle");
const btnCrearFalla = document.getElementById("btnCrearFalla");
const btnAutofecha = document.getElementById("btnAutofecha");

// Filtros
const qBuscar = document.getElementById("qBuscar");
const qEstado = document.getElementById("qEstado");
const qEquipo = document.getElementById("qEquipo");
const qOrden = document.getElementById("qOrden");
const qSoloAlertas = document.getElementById("qSoloAlertas");

const tbFallas = document.getElementById("tbFallas");
const lblConteo = document.getElementById("lblConteo");
const badgePendientes = document.getElementById("badgePendientes");

const btnPermisoNotif = document.getElementById("btnPermisoNotif");
const btnResetDemo = document.getElementById("btnResetDemo");

// Equipos
const eCodigo = document.getElementById("eCodigo");
const eNombre = document.getElementById("eNombre");
const eArea = document.getElementById("eArea");
const eModelo = document.getElementById("eModelo");
const eSerie = document.getElementById("eSerie");
const eNotas = document.getElementById("eNotas");
const btnCrearEquipo = document.getElementById("btnCrearEquipo");

const eImportText = document.getElementById("eImportText");
const btnImportEquiposPegado = document.getElementById("btnImportEquiposPegado");

const tbEquipos = document.getElementById("tbEquipos");

// Config
const cfgUmbral = document.getElementById("cfgUmbral");
const cfgRepetir = document.getElementById("cfgRepetir");
const btnGuardarCfg = document.getElementById("btnGuardarCfg");
const btnTestAviso = document.getElementById("btnTestAviso");

// Respaldo
const btnExportar = document.getElementById("btnExportar");
const btnImportar = document.getElementById("btnImportar");
const fileImport = document.getElementById("fileImport");
const dbgInfo = document.getElementById("dbgInfo");

// Dialog falla
const dlgFalla = document.getElementById("dlgFalla");
const dEquipo = document.getElementById("dEquipo");
const dTitulo = document.getElementById("dTitulo");
const dFecha = document.getElementById("dFecha");
const dUmbral = document.getElementById("dUmbral");
const dDetalle = document.getElementById("dDetalle");
const dEstado = document.getElementById("dEstado");
const dSolucion = document.getElementById("dSolucion");
const dComentariosInfo = document.getElementById("dComentariosInfo");
const dNuevoComentario = document.getElementById("dNuevoComentario");
const dComentariosLista = document.getElementById("dComentariosLista");
const btnAddComentario = document.getElementById("btnAddComentario");
const btnGuardarFallaEdit = document.getElementById("btnGuardarFallaEdit");
const btnCerrarDlg = document.getElementById("btnCerrarDlg");

// Dialog equipo
const dlgEquipo = document.getElementById("dlgEquipo");
const deCodigo = document.getElementById("deCodigo");
const deNombre = document.getElementById("deNombre");
const deArea = document.getElementById("deArea");
const deModelo = document.getElementById("deModelo");
const deSerie = document.getElementById("deSerie");
const deNotas = document.getElementById("deNotas");
const btnGuardarEquipoEdit = document.getElementById("btnGuardarEquipoEdit");
const btnCerrarDlgEq = document.getElementById("btnCerrarDlgEq");

// Toast
const toast = document.getElementById("toast");

let editingFallaId = null;
let editingEquipoId = null;

/* ===========================
   Helpers
   =========================== */

function getEquipoById(id) {
  return state.equipos.find(e => e.id === id) || null;
}

function getEquipoName(id) {
  const eq = getEquipoById(id);
  if (!eq) return "Equipo eliminado";
  const c = (eq.codigo || "").trim();
  const n = (eq.nombre || "").trim();
  const txt = `${c} • ${n}`.trim();
  return txt || "Equipo";
}

function parseDateTimeLocal(value) {
  const d = new Date(value);
  if (isNaN(d.getTime())) return null;
  return d;
}

function fmtDateTime(isoOrDate) {
  const d = (isoOrDate instanceof Date) ? isoOrDate : new Date(isoOrDate);
  if (isNaN(d.getTime())) return "-";
  return d.toLocaleString("es-GT", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}

function hoursSince(occurredIso) {
  const d = new Date(occurredIso);
  const ms = Date.now() - d.getTime();
  return ms / 3600000;
}

function classifyDelay(f) {
  if (f.resuelta) return { cls:"b-ok", label:"Solucionada", sev:"good" };
  const th = (typeof f.thresholdHours === "number") ? f.thresholdHours : state.config.thresholdHours;
  const h = hoursSince(f.occurredAt);
  if (h >= th * 2) return { cls:"b-bad", label:"Pendiente (crítica)", sev:"bad" };
  if (h >= th) return { cls:"b-warn", label:"Pendiente (alerta)", sev:"warn" };
  return { cls:"", label:"Pendiente", sev:"warn" };
}

function showToast(title, msg, sev="warn") {
  const div = document.createElement("div");
  div.className = `t ${sev}`;
  div.innerHTML = `<div class="title">${escapeHtml(title)}</div><div class="meta">${escapeHtml(msg)}</div>`;
  toast.appendChild(div);
  setTimeout(()=> div.remove(), 7000);
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m]));
}

function notify(title, body) {
  showToast(title, body, "warn");
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;
  try { new Notification(title, { body }); } catch {}
}

function refreshDebug() {
  dbgInfo.textContent =
    `Equipos: ${state.equipos.length} | Fallas: ${state.fallas.length} | ` +
    `Umbral global: ${state.config.thresholdHours} h | Repetir: ${state.config.repeatMinutes} min`;
}

function parseEquiposFromText(txt) {
  const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const result = [];
  for (const line of lines) {
    const parts = line.split(/\t+/);
    let codigo = "", denom = "";
    if (parts.length >= 2) {
      codigo = parts[0].trim();
      denom = parts.slice(1).join(" ").trim();
    } else {
      const m = line.match(/^(\S+)\s+(.*)$/);
      if (m) { codigo = m[1].trim(); denom = m[2].trim(); }
    }
    if (!codigo || !denom) continue;
    result.push({ codigo, denominacion: denom });
  }
  return result;
}

function equipoExistsByCodigo(codigo) {
  const c = (codigo||"").trim();
  if (!c) return false;
  return state.equipos.some(e => (e.codigo||"").trim() === c);
}

/* ===========================
   Render
   =========================== */

function renderSelects() {
  const opts = state.equipos.map(e => {
    const txt = `${(e.codigo||"").trim()} • ${e.nombre||""}`.trim();
    return `<option value="${e.id}">${escapeHtml(txt)}</option>`;
  }).join("");
  fEquipo.innerHTML = opts || `<option value="">(Crea un equipo primero)</option>`;
  dEquipo.innerHTML = fEquipo.innerHTML;

  const current = qEquipo.value;
  qEquipo.innerHTML = `<option value="todos">Todos</option>` + (opts || "");
  if ([...qEquipo.options].some(o => o.value === current)) qEquipo.value = current;

  if (!fEquipo.value && state.equipos[0]) fEquipo.value = state.equipos[0].id;
}

function renderEquipos() {
  tbEquipos.innerHTML = state.equipos.map(eq => `
    <tr>
      <td><strong>${escapeHtml(eq.codigo || "-")}</strong></td>
      <td>
        <strong>${escapeHtml(eq.nombre || "-")}</strong>
        <div class="muted">${escapeHtml(eq.serie || "")}</div>
      </td>
      <td>${escapeHtml(eq.area || "-")}</td>
      <td>${escapeHtml(eq.modelo || "-")}</td>
      <td class="right">
        <div class="actions">
          <button class="small" data-act="editEq" data-id="${eq.id}">Editar</button>
          <button class="small danger" data-act="delEq" data-id="${eq.id}">Eliminar</button>
        </div>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="5" class="muted">No hay equipos todavía.</td></tr>`;
}

function filteredFallas() {
  const text = qBuscar.value.trim().toLowerCase();
  const est = qEstado.value;
  const eq = qEquipo.value;
  const soloA = qSoloAlertas.value === "si";

  let arr = [...state.fallas];

  if (est === "pendientes") arr = arr.filter(f => !f.resuelta);
  if (est === "solucionadas") arr = arr.filter(f => f.resuelta);

  if (eq !== "todos") arr = arr.filter(f => f.equipoId === eq);

  if (text) {
    arr = arr.filter(f => {
      const hay = [
        getEquipoName(f.equipoId),
        f.titulo, f.detalle,
        (f.comentarios||[]).map(c => c.text).join(" ")
      ].join(" ").toLowerCase();
      return hay.includes(text);
    });
  }

  if (soloA) {
    arr = arr.filter(f => {
      if (f.resuelta) return false;
      const th = (typeof f.thresholdHours === "number") ? f.thresholdHours : state.config.thresholdHours;
      return hoursSince(f.occurredAt) >= th;
    });
  }

  const ord = qOrden.value;
  if (ord === "recientes") arr.sort((a,b)=> new Date(b.occurredAt)-new Date(a.occurredAt));
  if (ord === "antiguas") arr.sort((a,b)=> new Date(a.occurredAt)-new Date(b.occurredAt));
  if (ord === "mas_atrasadas") {
    arr.sort((a,b)=>{
      const aKey = a.resuelta ? -1 : hoursSince(a.occurredAt);
      const bKey = b.resuelta ? -1 : hoursSince(b.occurredAt);
      return bKey - aKey;
    });
  }

  return arr;
}

function renderFallas() {
  const pend = state.fallas.filter(f => !f.resuelta).length;
  badgePendientes.textContent = `Pendientes: ${pend}`;
  badgePendientes.className = "badge " + (pend === 0 ? "b-ok" : "b-warn");

  const arr = filteredFallas();
  lblConteo.textContent = `${arr.length} registro(s) mostrado(s)`;

  tbFallas.innerHTML = arr.map(f => {
    const cls = classifyDelay(f);
    const th = (typeof f.thresholdHours === "number") ? f.thresholdHours : state.config.thresholdHours;
    const h = hoursSince(f.occurredAt);
    const atras = f.resuelta ? "-" : `${h.toFixed(1)} h (umbral ${th} h)`;

    return `
      <tr>
        <td><span class="badge ${cls.cls}">${escapeHtml(cls.label)}</span></td>
        <td><strong>${escapeHtml(getEquipoName(f.equipoId))}</strong></td>
        <td>
          <strong>${escapeHtml(f.titulo || "(Sin título)")}</strong>
          <div class="muted">${escapeHtml((f.detalle||"").slice(0,90))}${(f.detalle||"").length>90?"…":""}</div>
        </td>
        <td>${escapeHtml(fmtDateTime(f.occurredAt))}</td>
        <td>${escapeHtml(atras)}</td>
        <td class="right">
          <div class="actions">
            <button class="small" data-act="editF" data-id="${f.id}">Editar</button>
            ${f.resuelta
              ? `<button class="small" data-act="reopenF" data-id="${f.id}">Reabrir</button>`
              : `<button class="small good" data-act="solveF" data-id="${f.id}">Marcar solucionada</button>`
            }
            <button class="small danger" data-act="delF" data-id="${f.id}">Eliminar</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="6" class="muted">No hay fallas con esos filtros.</td></tr>`;
}

function renderAll() {
  renderSelects();
  renderEquipos();
  renderFallas();
  cfgUmbral.value = state.config.thresholdHours;
  cfgRepetir.value = state.config.repeatMinutes;
  if (!fFecha.value) fFecha.value = nowLocalISO();
  refreshDebug();
}

/* ===========================
   Tabs
   =========================== */
tabs.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    tabs.forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    Object.values(panes).forEach(p=> p.style.display="none");
    panes[tab].style.display = "";
  });
});

/* ===========================
   Acciones: Crear/Editar
   =========================== */

btnAutofecha.addEventListener("click", ()=> fFecha.value = nowLocalISO());

btnCrearEquipo.addEventListener("click", ()=>{
  const nombre = eNombre.value.trim();
  if (!nombre) return showToast("Falta la denominación", "Escribe un nombre para guardar.", "bad");

  state.equipos.push({
    id: uid("eq"),
    codigo: eCodigo.value.trim(),
    nombre,
    area: eArea.value.trim(),
    modelo: eModelo.value.trim(),
    serie: eSerie.value.trim(),
    notas: eNotas.value.trim()
  });

  eCodigo.value = "";
  eNombre.value = "";
  eArea.value = "";
  eModelo.value = "";
  eSerie.value = "";
  eNotas.value = "";

  saveState();
  renderAll();
  showToast("Equipo guardado", nombre, "good");
});

btnImportEquiposPegado.addEventListener("click", ()=>{
  const txt = eImportText.value.trim();
  if (!txt) return showToast("Nada que importar", "Pega tu lista primero.", "bad");

  const items = parseEquiposFromText(txt);
  if (!items.length) return showToast("Formato no reconocido", "Asegúrate de tener Código y Denominación por línea.", "bad");

  let added = 0, skipped = 0;
  for (const it of items) {
    if (equipoExistsByCodigo(it.codigo)) { skipped++; continue; }
    state.equipos.push({
      id: uid("eq"),
      codigo: it.codigo,
      nombre: it.denominacion,
      area: "",
      modelo: "",
      serie: "",
      notas: ""
    });
    added++;
  }

  saveState();
  renderAll();
  showToast("Importación terminada", `Agregados: ${added} • Duplicados omitidos: ${skipped}`, "good");
  eImportText.value = "";
});

btnCrearFalla.addEventListener("click", ()=>{
  if (!state.equipos.length) return showToast("Primero crea un equipo", "Ve a la pestaña Equipos.", "bad");
  const equipoId = fEquipo.value;
  const titulo = fTitulo.value.trim();
  const dt = parseDateTimeLocal(fFecha.value);
  if (!dt) return showToast("Fecha/hora inválida", "Revisa la fecha/hora de la falla.", "bad");

  const umbralRaw = fUmbral.value.trim();
  const thresholdHours = umbralRaw === "" ? null : Number(umbralRaw);
  if (umbralRaw !== "" && (!isFinite(thresholdHours) || thresholdHours < 0)) {
    return showToast("Umbral inválido", "Debe ser un número >= 0.", "bad");
  }

  state.fallas.push({
    id: uid("fa"),
    equipoId,
    titulo,
    detalle: fDetalle.value.trim(),
    occurredAt: dt.toISOString(),
    thresholdHours: thresholdHours === null ? undefined : thresholdHours,
    resuelta: false,
    resolvedAt: null,
    solucionNotas: "",
    comentarios: [],
    lastNotifiedAt: null,
    createdAt: new Date().toISOString()
  });

  fTitulo.value = "";
  fDetalle.value = "";
  fUmbral.value = "";
  fFecha.value = nowLocalISO();

  saveState();
  renderFallas();
  showToast("Falla registrada", `${getEquipoName(equipoId)} • ${titulo || "Sin título"}`, "good");
});

function openFallaDialog(f) {
  editingFallaId = f.id;
  dEquipo.value = f.equipoId;
  dTitulo.value = f.titulo || "";

  const d = new Date(f.occurredAt);
  const pad = n => String(n).padStart(2,"0");
  const localVal = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  dFecha.value = localVal;

  dUmbral.value = (typeof f.thresholdHours === "number") ? f.thresholdHours : "";
  dDetalle.value = f.detalle || "";
  dEstado.value = f.resuelta ? "solucionada" : "pendiente";
  dSolucion.value = f.solucionNotas || "";
  renderComentarios(f);
  dlgFalla.showModal();
}

function renderComentarios(f) {
  const list = (f.comentarios||[]).slice().sort((a,b)=> new Date(b.at)-new Date(a.at));
  dComentariosInfo.textContent = list.length ? `${list.length} comentario(s)` : "Sin comentarios.";
  dComentariosLista.innerHTML = list.map(c => `
    <div class="card" style="margin:8px 0; background: rgba(2,6,23,.25)">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
        <div><strong>${escapeHtml(fmtDateTime(c.at))}</strong></div>
        <button class="small danger" data-act="delCom" data-id="${f.id}" data-cid="${c.id}">Eliminar</button>
      </div>
      <div class="muted" style="margin-top:6px; white-space: pre-wrap;">${escapeHtml(c.text)}</div>
    </div>
  `).join("");
}

btnAddComentario.addEventListener("click", ()=>{
  const text = dNuevoComentario.value.trim();
  if (!text) return showToast("Comentario vacío", "Escribe algo antes de agregar.", "bad");
  const f = state.fallas.find(x => x.id === editingFallaId);
  if (!f) return;
  f.comentarios.push({ id: uid("c"), at: new Date().toISOString(), text });
  dNuevoComentario.value = "";
  saveState();
  renderComentarios(f);
  showToast("Comentario agregado", "Se guardó en el historial.", "good");
});

btnGuardarFallaEdit.addEventListener("click", ()=>{
  const f = state.fallas.find(x => x.id === editingFallaId);
  if (!f) return;

  const dt = parseDateTimeLocal(dFecha.value);
  if (!dt) return showToast("Fecha/hora inválida", "Revisa la fecha/hora.", "bad");

  const umbralRaw = dUmbral.value.trim();
  const thresholdHours = umbralRaw === "" ? null : Number(umbralRaw);
  if (umbralRaw !== "" && (!isFinite(thresholdHours) || thresholdHours < 0)) {
    return showToast("Umbral inválido", "Debe ser un número >= 0.", "bad");
  }

  f.equipoId = dEquipo.value;
  f.titulo = dTitulo.value.trim();
  f.detalle = dDetalle.value.trim();
  f.occurredAt = dt.toISOString();
  if (thresholdHours === null) delete f.thresholdHours; else f.thresholdHours = thresholdHours;

  const wantSolved = dEstado.value === "solucionada";
  if (wantSolved && !f.resuelta) f.resolvedAt = new Date().toISOString();
  if (!wantSolved) f.resolvedAt = null;
  f.resuelta = wantSolved;
  f.solucionNotas = dSolucion.value.trim();

  if (!f.resuelta) f.lastNotifiedAt = null;

  saveState();
  renderFallas();
  dlgFalla.close();
  showToast("Cambios guardados", "Se actualizó la falla.", "good");
});

btnCerrarDlg.addEventListener("click", ()=> dlgFalla.close());

function openEquipoDialog(eq) {
  editingEquipoId = eq.id;
  deCodigo.value = eq.codigo || "";
  deNombre.value = eq.nombre || "";
  deArea.value = eq.area || "";
  deModelo.value = eq.modelo || "";
  deSerie.value = eq.serie || "";
  deNotas.value = eq.notas || "";
  dlgEquipo.showModal();
}

btnGuardarEquipoEdit.addEventListener("click", ()=>{
  const eq = state.equipos.find(x => x.id === editingEquipoId);
  if (!eq) return;
  const nombre = deNombre.value.trim();
  if (!nombre) return showToast("Falta la denominación", "No puede quedar vacío.", "bad");

  eq.codigo = deCodigo.value.trim();
  eq.nombre = nombre;
  eq.area = deArea.value.trim();
  eq.modelo = deModelo.value.trim();
  eq.serie = deSerie.value.trim();
  eq.notas = deNotas.value.trim();

  saveState();
  renderAll();
  dlgEquipo.close();
  showToast("Equipo actualizado", nombre, "good");
});

btnCerrarDlgEq.addEventListener("click", ()=> dlgEquipo.close());

/* ===========================
   Delegación de eventos
   =========================== */
document.addEventListener("click", (ev)=>{
  const b = ev.target.closest("button");
  if (!b) return;
  const act = b.dataset.act;
  const id = b.dataset.id;
  if (!act) return;

  if (act === "editF") {
    const f = state.fallas.find(x => x.id === id);
    if (f) openFallaDialog(f);
  }
  if (act === "solveF") {
    const f = state.fallas.find(x => x.id === id);
    if (!f) return;
    f.resuelta = true;
    f.resolvedAt = new Date().toISOString();
    saveState(); renderFallas();
    showToast("Marcada como solucionada", `${getEquipoName(f.equipoId)} • ${f.titulo||"Sin título"}`, "good");
  }
  if (act === "reopenF") {
    const f = state.fallas.find(x => x.id === id);
    if (!f) return;
    f.resuelta = false;
    f.resolvedAt = null;
    f.lastNotifiedAt = null;
    saveState(); renderFallas();
    showToast("Falla reabierta", `${getEquipoName(f.equipoId)} • ${f.titulo||"Sin título"}`, "warn");
  }
  if (act === "delF") {
    const f = state.fallas.find(x => x.id === id);
    if (!f) return;
    if (!confirm("¿Eliminar esta falla?")) return;
    state.fallas = state.fallas.filter(x => x.id !== id);
    saveState(); renderFallas();
    showToast("Falla eliminada", "Se eliminó del historial.", "good");
  }

  if (act === "editEq") {
    const eq = state.equipos.find(x => x.id === id);
    if (eq) openEquipoDialog(eq);
  }
  if (act === "delEq") {
    const eq = state.equipos.find(x => x.id === id);
    if (!eq) return;
    if (!confirm(`¿Eliminar equipo "${eq.nombre}"?`)) return;
    state.equipos = state.equipos.filter(x => x.id !== id);
    saveState(); renderAll();
    showToast("Equipo eliminado", eq.nombre, "good");
  }

  if (act === "delCom") {
    const fallaId = b.dataset.id;
    const cid = b.dataset.cid;
    const f = state.fallas.find(x => x.id === fallaId);
    if (!f) return;
    if (!confirm("¿Eliminar este comentario?")) return;
    f.comentarios = (f.comentarios||[]).filter(c => c.id !== cid);
    saveState();
    renderComentarios(f);
    showToast("Comentario eliminado", "Se actualizó el historial.", "good");
  }
});

/* ===========================
   Filtros
   =========================== */
[qBuscar, qEstado, qEquipo, qOrden, qSoloAlertas].forEach(el => el.addEventListener("input", renderFallas));
[qEstado, qEquipo, qOrden, qSoloAlertas].forEach(el => el.addEventListener("change", renderFallas));

/* ===========================
   Config / Notifs
   =========================== */

btnGuardarCfg.addEventListener("click", ()=>{
  const th = Number(cfgUmbral.value);
  const rep = Number(cfgRepetir.value);
  if (!isFinite(th) || th < 0) return showToast("Umbral inválido", "Debe ser número >= 0.", "bad");
  if (!isFinite(rep) || rep < 1) return showToast("Repetición inválida", "Debe ser mínimo 1 minuto.", "bad");
  state.config.thresholdHours = th;
  state.config.repeatMinutes = rep;
  saveState();
  renderAll();
  showToast("Configuración guardada", `Umbral ${th} h • Repetir ${rep} min`, "good");
});

btnPermisoNotif.addEventListener("click", async ()=>{
  if (!("Notification" in window)) {
    return showToast("No disponible", "Este navegador no soporta notificaciones.", "bad");
  }
  try {
    const p = await Notification.requestPermission();
    if (p === "granted") showToast("Listo", "Notificaciones activadas.", "good");
    else showToast("Permiso no concedido", "Puedes usar avisos en pantalla igualmente.", "warn");
  } catch {
    showToast("Error", "No se pudo solicitar permiso.", "bad");
  }
});

btnTestAviso.addEventListener("click", ()=>{
  notify("Prueba de aviso", "Esto es un aviso de prueba del Control de Fallas.");
});

btnResetDemo.addEventListener("click", ()=>{
  if (!confirm("¿Seguro? Esto borrará equipos y fallas.")) return;
  localStorage.removeItem(STORE_KEY);
  state = defaultState();
  saveState();
  renderAll();
  showToast("Listo", "Se borró todo.", "good");
});

/* ===========================
   Export / Import
   =========================== */
btnExportar.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `control_fallas_respaldo_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("Exportado", "Se descargó el respaldo JSON.", "good");
});

btnImportar.addEventListener("click", ()=> fileImport.click());

fileImport.addEventListener("change", async ()=>{
  const file = fileImport.files?.[0];
  if (!file) return;
  try {
    const text = await file.text();
    const imported = JSON.parse(text);
    state = normalizeState(imported);
    saveState();
    renderAll();
    showToast("Importado", "Respaldo restaurado correctamente.", "good");
  } catch {
    showToast("Error", "El archivo no es un JSON válido.", "bad");
  } finally {
    fileImport.value = "";
  }
});

/* ===========================
   Motor de avisos
   =========================== */
function checkAlerts() {
  const repeatMs = state.config.repeatMinutes * 60 * 1000;
  let any = false;

  for (const f of state.fallas) {
    if (f.resuelta) continue;

    const th = (typeof f.thresholdHours === "number") ? f.thresholdHours : state.config.thresholdHours;
    if (th <= 0) continue;

    const h = hoursSince(f.occurredAt);
    if (h < th) continue;

    any = true;
    const last = f.lastNotifiedAt ? new Date(f.lastNotifiedAt).getTime() : 0;
    const due = (Date.now() - last) >= repeatMs;

    if (due) {
      f.lastNotifiedAt = new Date().toISOString();
      saveState();
      const equipo = getEquipoName(f.equipoId);
      const title = `ALERTA: Falla pendiente (${h.toFixed(1)} h)`;
      const body = `${equipo} • ${f.titulo || "Sin título"}`;
      notify(title, body);
    }
  }

  document.title = any ? "⚠ Control de Fallas" : "Control de Fallas";
}

setInterval(checkAlerts, 60 * 1000);
setTimeout(checkAlerts, 800);

/* ===========================
   Init
   =========================== */
fFecha.value = nowLocalISO();
renderAll();
</script>
</body>
</html>
